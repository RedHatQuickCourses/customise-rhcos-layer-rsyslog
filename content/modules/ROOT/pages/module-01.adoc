= Build the Custom RHCOS Image

[#step1]
== Step 1: Identify the Base RHCOS Image

First, you need to determine the exact base RHCOS image used by your cluster. This ensures your custom image is built on the correct foundation.

. Execute the following command to get the image reference:
+
[source,bash,role=execute]
----
oc adm release info --image-for rhel-coreos
----
+
.Example Output:
....
quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:cbe2965ad3a408286fe06e4a7a58e006621f33847c17f8e8ff84504dbeebe666
....
+
Take note of the full image URL with the SHA256 digest. You will use this as the `FROM` image in your Dockerfile.

[#step2]
== Step 2: Build the Custom RHCOS Image on a RHEL Host

Next, prepare a build environment on your RHEL host to create the layered image.

=== 1. Prepare the Build Directory and RPMs

Create a working directory and download the necessary RPM packages and their dependencies. We need `rsyslog` for logging, `plymouth` to help write logs to `/var/log/boot.log` during startup, and other required libraries.

. Create a working directory and download the RPMs.
+
[source,bash,role=execute]
----
mkdir -p /data/rhcos-build
cd /data/rhcos-build
dnf download --resolve --destdir=. rsyslog libestr libfastjson logrotate plymouth plymouth-core-libs plymouth-scripts
----

=== 2. Create the Dockerfile

Create a `Dockerfile` (or `Containerfile`) to define the build process for your custom image. This file will start from the base RHCOS image, copy the downloaded RPMs, install them, and then commit the changes to the OS layer.

. Define the base image using the output from Step 1 and create the Dockerfile.
+
[source,bash,role=execute]
----
RHCOS_IMAGE=$(oc adm release info --image-for rhel-coreos)
tee /data/rhcos-build/rhcos.dockerfile << EOF
FROM \${RHCOS_IMAGE}

# Copy the downloaded RPMs into the container
COPY *.rpm /root/

# Install the RPMs using dnf and commit the layer to ostree
RUN cd /root && \
    dnf install --nobest -y ./*.x86_64.rpm && \
    ostree container commit

# Clean up the RPM files
RUN rm -f /root/*.rpm

# Optional: Add custom configurations
# For example, to add a custom rsyslog configuration file:
# ADD remote.conf /etc/rsyslog.d/remote.conf
EOF
----

=== 3. Build and Push the Image

Now, build the image using `podman` and push it to your container registry. Make sure you are logged into your registry and have your pull secret available.

. Define your custom image tag, then build and push the image.
+
[source,bash,role=execute]
----
CUSTOM_IMAGE="quay.io/wangzheng422/qimgs:rhcos-4.18-rsyslog-$(date +%Y.%m.%d)-v01"
podman build --authfile /path/to/pull-secret.json -t \${CUSTOM_IMAGE} -f /data/rhcos-build/rhcos.dockerfile /data/rhcos-build
podman push \${CUSTOM_IMAGE}
----
